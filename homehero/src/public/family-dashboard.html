<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Dashboard - HomeHero</title>
  <!-- Preconnect hints for performance -->
  <link rel="preconnect" href="./api" crossorigin>
  <link rel="dns-prefetch" href="./api">
  <!-- Ingress support for Home Assistant sidebar -->
  <script src="./js/ingress.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #E8F5E9 0%, #F3E5F5 50%, #E3F2FD 100%);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* Header */
    .dashboard-header {
      background: white;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      font-size: 32px;
    }

    .header-text h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #5D4E6D;
    }

    .header-text .date {
      font-size: 0.9rem;
      color: #757575;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .vacation-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: #F5F5F5;
      border-radius: 12px;
      font-size: 0.9rem;
      color: #5D4E6D;
    }

    .vacation-toggle.active {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: #E0E0E0;
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.on {
      background: #FFB74D;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch.on::after {
      transform: translateX(22px);
    }

    .logout-btn {
      background: none;
      border: 2px solid #E0E0E0;
      color: #757575;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      border-color: #E53935;
      color: #E53935;
    }

    /* Main Content */
    .dashboard-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Summary Section */
    .summary-section {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .summary-card {
      flex: 1;
      min-width: 150px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .summary-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .summary-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #5D4E6D;
    }

    .summary-label {
      font-size: 0.85rem;
      color: #757575;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-card.complete .summary-value {
      color: #2E7D32;
    }

    .summary-card.pending .summary-value {
      color: #E65100;
    }

    /* Family Members Grid */
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-icon {
      font-size: 28px;
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #5D4E6D;
    }

    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    /* Member Card */
    .member-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      min-height: 200px;
    }

    .member-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .member-card:active {
      transform: scale(0.98);
    }

    .member-card.complete {
      border: 3px solid #81C784;
    }

    .member-card.incomplete {
      border: 3px solid #FFB74D;
    }

    .member-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .member-avatar {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .member-info {
      flex: 1;
      min-width: 0;
    }

    .member-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #5D4E6D;
      margin-bottom: 4px;
    }

    .member-role {
      font-size: 0.85rem;
      color: #757575;
      text-transform: capitalize;
    }

    .member-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }

    .member-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-icon {
      font-size: 1.2rem;
    }

    .stat-text {
      font-size: 1rem;
      font-weight: 600;
      color: #5D4E6D;
    }

    .streak-stat .stat-text {
      color: #E65100;
    }

    .balance-stat .stat-text {
      color: #2E7D32;
    }

    /* Progress Bar */
    .member-progress {
      margin-bottom: 16px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 0.85rem;
      color: #757575;
    }

    .progress-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #7E57C2;
    }

    .progress-bar-container {
      height: 12px;
      background: #E0E0E0;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #81C784 0%, #66BB6A 100%);
      border-radius: 6px;
      transition: width 0.5s ease-out;
    }

    .progress-bar.complete {
      background: linear-gradient(90deg, #FFD54F 0%, #FFCA28 100%);
    }

    /* Missed Tasks Badge */
    .missed-tasks-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #FFF3E0;
      color: #E65100;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .missed-tasks-badge.hidden {
      display: none;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #F0F0F0;
    }

    .action-btn {
      flex: 1;
      background: #F5F5F5;
      border: none;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #5D4E6D;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .action-btn:hover {
      background: #EEEEEE;
    }

    .action-btn:active {
      transform: scale(0.95);
    }

    .action-btn.sick-day {
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    }

    .action-btn.sick-day:hover {
      background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%);
    }

    /* Complete Badge */
    .complete-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #81C784;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(129, 199, 132, 0.4);
    }

    .complete-badge.hidden {
      display: none;
    }

    /* Member Detail Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.visible .modal-content {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #757575;
      cursor: pointer;
      padding: 8px;
    }

    .modal-close:hover {
      color: #5D4E6D;
    }

    .modal-member-header {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .modal-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #5D4E6D;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #F8F9FA;
      border-radius: 12px;
    }

    .task-item.completed {
      background: #E8F5E9;
    }

    .task-item.missed {
      background: #FFF3E0;
    }

    .task-icon {
      font-size: 1.5rem;
    }

    .task-name {
      flex: 1;
      font-weight: 500;
      color: #5D4E6D;
    }

    .task-status {
      font-size: 1.2rem;
    }

    .transaction-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .transaction-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #F8F9FA;
      border-radius: 10px;
    }

    .transaction-desc {
      font-size: 0.9rem;
      color: #5D4E6D;
    }

    .transaction-amount {
      font-weight: 600;
    }

    .transaction-amount.positive {
      color: #2E7D32;
    }

    .transaction-amount.negative {
      color: #E53935;
    }

    /* Loading State */
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 20px;
    }

    .loading-spinner-large {
      width: 60px;
      height: 60px;
      border: 5px solid #E0E0E0;
      border-top-color: #7E57C2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #7E57C2;
      font-size: 1.1rem;
      font-weight: 500;
    }

    /* Error State */
    .error-screen {
      text-align: center;
      padding: 40px;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 15px;
    }

    .error-message {
      color: #E53935;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }

    .retry-btn {
      background: #7E57C2;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .retry-btn:hover {
      background: #673AB7;
    }

    /* Access Denied */
    .access-denied {
      text-align: center;
      padding: 60px 20px;
    }

    .access-denied-icon {
      font-size: 5rem;
      margin-bottom: 20px;
    }

    .access-denied-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #5D4E6D;
      margin-bottom: 10px;
    }

    .access-denied-text {
      color: #757575;
      margin-bottom: 30px;
    }

    .back-to-dashboard-btn {
      background: #7E57C2;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .back-to-dashboard-btn:hover {
      background: #673AB7;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 15px;
    }

    .empty-state-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #5D4E6D;
      margin-bottom: 8px;
    }

    .empty-state-text {
      color: #757575;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }

      .summary-section {
        flex-direction: column;
      }

      .summary-card {
        min-width: auto;
      }

      .members-grid {
        grid-template-columns: 1fr;
      }

      .member-stats {
        flex-wrap: wrap;
      }

      .vacation-toggle span {
        display: none;
      }

      .vacation-toggle .toggle-icon {
        display: block;
      }
    }

    /* Large touch targets for touch devices */
    @media (pointer: coarse) {
      .member-card {
        min-height: 220px;
        padding: 28px;
      }

      .action-btn {
        padding: 14px;
        min-height: 48px;
      }

      .toggle-switch {
        width: 56px;
        height: 32px;
      }

      .toggle-switch::after {
        width: 26px;
        height: 26px;
      }

      .toggle-switch.on::after {
        transform: translateX(24px);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <span class="header-icon">&#x1F3E0;</span>
        <div class="header-text">
          <h1>Family Dashboard</h1>
          <span class="date" id="current-date">Loading...</span>
        </div>
      </div>

      <div class="header-actions">
        <div class="vacation-toggle" id="vacation-toggle">
          <span class="toggle-icon">&#x1F3D6;&#xFE0F;</span>
          <span>Vacation Mode</span>
          <div class="toggle-switch" id="vacation-switch"></div>
        </div>

        <button class="logout-btn" onclick="logout()">Log Out</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-content">
    <!-- Loading State -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-spinner-large"></div>
      <div class="loading-text">Loading family dashboard...</div>
    </div>

    <!-- Access Denied State -->
    <div id="access-denied" class="access-denied" style="display: none;">
      <div class="access-denied-icon">&#x1F6AB;</div>
      <div class="access-denied-title">Parent Access Required</div>
      <div class="access-denied-text">This page is only available to parents.</div>
      <a href="./dashboard.html" class="back-to-dashboard-btn">Go to My Dashboard</a>
    </div>

    <!-- Error State -->
    <div id="error-screen" class="error-screen" style="display: none;">
      <div class="error-icon">&#x1F615;</div>
      <div class="error-message" id="error-message">Something went wrong</div>
      <button class="retry-btn" onclick="loadDashboard()">Try Again</button>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-main" style="display: none;">
      <!-- Summary Section -->
      <div class="summary-section" id="summary-section">
        <!-- Dynamically populated -->
      </div>

      <!-- Family Members Section -->
      <section class="family-section">
        <div class="section-header">
          <span class="section-icon">&#x1F46A;</span>
          <h2 class="section-title">Family Members</h2>
        </div>
        <div id="members-grid" class="members-grid">
          <!-- Dynamically populated -->
        </div>
        <div id="members-empty" class="empty-state" style="display: none;">
          <div class="empty-state-icon">&#x1F465;</div>
          <div class="empty-state-title">No family members found</div>
          <div class="empty-state-text">Add family members to see their progress here.</div>
        </div>
      </section>
    </div>
  </main>

  <!-- Member Detail Modal -->
  <div id="member-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-member-header">
          <div class="modal-avatar" id="modal-avatar"></div>
          <div>
            <div class="member-name" id="modal-name"></div>
            <div class="member-role" id="modal-role"></div>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>

      <div id="modal-loading" class="loading-screen" style="min-height: 200px;">
        <div class="loading-spinner-large"></div>
        <div class="loading-text">Loading details...</div>
      </div>

      <div id="modal-content" style="display: none;">
        <!-- Stats -->
        <div class="member-stats" style="justify-content: center; margin-bottom: 24px;">
          <div class="member-stat streak-stat">
            <span class="stat-icon">&#x1F525;</span>
            <span class="stat-text" id="modal-streak">0 day streak</span>
          </div>
          <div class="member-stat balance-stat">
            <span class="stat-icon">&#x1F4B0;</span>
            <span class="stat-text" id="modal-balance">$0.00</span>
          </div>
        </div>

        <!-- Today's Tasks -->
        <div class="modal-section">
          <div class="modal-section-title">
            <span>&#x1F4CB;</span>
            <span>Today's Tasks</span>
          </div>
          <div id="modal-tasks" class="task-list">
            <!-- Dynamically populated -->
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="modal-section">
          <div class="modal-section-title">
            <span>&#x1F4B5;</span>
            <span>Recent Earnings</span>
          </div>
          <div id="modal-transactions" class="transaction-list">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    var dashboardData = null;
    var user = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      var token = localStorage.getItem('token');
      var userData = localStorage.getItem('user');

      if (!token || !userData) {
        ingressRedirect('/login.html');
        return;
      }

      try {
        user = JSON.parse(userData);

        // Check if user is a parent
        if (user.role !== 'parent') {
          showAccessDenied();
          return;
        }

        updateDate();
        loadDashboard();
      } catch (e) {
        console.error('Error parsing user data:', e);
        logout();
      }
    });

    // Update current date display
    function updateDate() {
      var dateEl = document.getElementById('current-date');
      var today = new Date();
      var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      dateEl.textContent = today.toLocaleDateString('en-US', options);
    }

    // Show access denied screen
    function showAccessDenied() {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('access-denied').style.display = 'block';
    }

    // Load dashboard data
    async function loadDashboard() {
      var loadingScreen = document.getElementById('loading-screen');
      var errorScreen = document.getElementById('error-screen');
      var mainContent = document.getElementById('dashboard-main');

      loadingScreen.style.display = 'flex';
      errorScreen.style.display = 'none';
      mainContent.style.display = 'none';

      try {
        var token = localStorage.getItem('token');
        var response = await fetch('./api/family/dashboard', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.status === 403) {
          showAccessDenied();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to load dashboard');
        }

        dashboardData = await response.json();
        renderDashboard();

        loadingScreen.style.display = 'none';
        mainContent.style.display = 'block';
      } catch (err) {
        console.error('Error loading dashboard:', err);
        loadingScreen.style.display = 'none';
        errorScreen.style.display = 'block';
        document.getElementById('error-message').textContent = err.message || 'Failed to load family dashboard';
      }
    }

    // Render dashboard
    function renderDashboard() {
      if (!dashboardData) return;

      // Update vacation mode toggle
      updateVacationToggle(dashboardData.household.vacationMode);

      // Render summary
      renderSummary();

      // Render members
      renderMembers();
    }

    // Update vacation toggle state
    function updateVacationToggle(isOn) {
      var toggleContainer = document.getElementById('vacation-toggle');
      var toggleSwitch = document.getElementById('vacation-switch');

      if (isOn) {
        toggleContainer.classList.add('active');
        toggleSwitch.classList.add('on');
      } else {
        toggleContainer.classList.remove('active');
        toggleSwitch.classList.remove('on');
      }

      // Add click handler
      toggleSwitch.onclick = function() {
        toggleVacationMode(!isOn);
      };
    }

    // Toggle vacation mode
    async function toggleVacationMode(enabled) {
      try {
        var token = localStorage.getItem('token');
        var response = await fetch('./api/family/vacation-mode', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ enabled: enabled })
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to toggle vacation mode');
        }

        var data = await response.json();
        dashboardData.household.vacationMode = data.vacationMode;
        updateVacationToggle(data.vacationMode);
      } catch (err) {
        console.error('Error toggling vacation mode:', err);
        alert('Failed to toggle vacation mode');
      }
    }

    // Render summary section
    function renderSummary() {
      var container = document.getElementById('summary-section');
      // Clear container safely
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      // Total Members
      var totalCard = createSummaryCard('\u{1F46A}', dashboardData.summary.totalMembers, 'Family Members');
      container.appendChild(totalCard);

      // Members Complete
      var completeCard = createSummaryCard('\u{2705}', dashboardData.summary.membersComplete, 'All Done Today', 'complete');
      container.appendChild(completeCard);

      // Missed Tasks
      var missedCard = createSummaryCard('\u{23F3}', dashboardData.summary.totalMissedTasks, 'Tasks Remaining', 'pending');
      container.appendChild(missedCard);
    }

    // Create a summary card element
    function createSummaryCard(icon, value, label, className) {
      var card = document.createElement('div');
      card.className = 'summary-card' + (className ? ' ' + className : '');

      var iconEl = document.createElement('div');
      iconEl.className = 'summary-icon';
      iconEl.textContent = icon;

      var valueEl = document.createElement('div');
      valueEl.className = 'summary-value';
      valueEl.textContent = value;

      var labelEl = document.createElement('div');
      labelEl.className = 'summary-label';
      labelEl.textContent = label;

      card.appendChild(iconEl);
      card.appendChild(valueEl);
      card.appendChild(labelEl);

      return card;
    }

    // Render members grid
    function renderMembers() {
      var container = document.getElementById('members-grid');
      var emptyState = document.getElementById('members-empty');

      // Clear container safely
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      if (dashboardData.members.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      container.style.display = 'grid';
      emptyState.style.display = 'none';

      dashboardData.members.forEach(function(member) {
        container.appendChild(createMemberCard(member));
      });
    }

    // Create member card element
    function createMemberCard(member) {
      var card = document.createElement('div');
      card.className = 'member-card' + (member.routineComplete ? ' complete' : ' incomplete');
      card.onclick = function() {
        openMemberModal(member);
      };

      // Complete badge
      var badge = document.createElement('div');
      badge.className = 'complete-badge' + (member.routineComplete ? '' : ' hidden');
      badge.textContent = '\u2713';
      card.appendChild(badge);

      // Header
      var header = document.createElement('div');
      header.className = 'member-header';

      var avatar = document.createElement('div');
      avatar.className = 'member-avatar';
      if (member.avatar) {
        avatar.style.backgroundColor = member.avatar.color || '#E0E0E0';
        avatar.textContent = member.avatar.emoji || '\u{1F464}';
      } else {
        avatar.style.backgroundColor = '#E0E0E0';
        avatar.textContent = '\u{1F464}';
      }

      var info = document.createElement('div');
      info.className = 'member-info';

      var name = document.createElement('div');
      name.className = 'member-name';
      name.textContent = member.name;

      var role = document.createElement('div');
      role.className = 'member-role';
      role.textContent = member.role;

      info.appendChild(name);
      info.appendChild(role);
      header.appendChild(avatar);
      header.appendChild(info);
      card.appendChild(header);

      // Stats
      var stats = document.createElement('div');
      stats.className = 'member-stats';

      // Streak stat
      var streakStat = document.createElement('div');
      streakStat.className = 'member-stat streak-stat';

      var streakIcon = document.createElement('span');
      streakIcon.className = 'stat-icon';
      streakIcon.textContent = '\u{1F525}';

      var streakText = document.createElement('span');
      streakText.className = 'stat-text';
      streakText.textContent = member.streak + ' day' + (member.streak !== 1 ? 's' : '');

      streakStat.appendChild(streakIcon);
      streakStat.appendChild(streakText);

      // Balance stat
      var balanceStat = document.createElement('div');
      balanceStat.className = 'member-stat balance-stat';

      var balanceIcon = document.createElement('span');
      balanceIcon.className = 'stat-icon';
      balanceIcon.textContent = '\u{1F4B0}';

      var balanceText = document.createElement('span');
      balanceText.className = 'stat-text';
      balanceText.textContent = member.balance.formatted;

      balanceStat.appendChild(balanceIcon);
      balanceStat.appendChild(balanceText);

      stats.appendChild(streakStat);
      stats.appendChild(balanceStat);
      card.appendChild(stats);

      // Progress
      var progress = document.createElement('div');
      progress.className = 'member-progress';

      var progressHeader = document.createElement('div');
      progressHeader.className = 'progress-header';

      var progressLabel = document.createElement('span');
      progressLabel.className = 'progress-label';
      progressLabel.textContent = "Today's Progress";

      var progressValue = document.createElement('span');
      progressValue.className = 'progress-value';
      progressValue.textContent = member.progress.completed + ' of ' + member.progress.total;

      progressHeader.appendChild(progressLabel);
      progressHeader.appendChild(progressValue);

      var progressBarContainer = document.createElement('div');
      progressBarContainer.className = 'progress-bar-container';

      var progressBar = document.createElement('div');
      progressBar.className = 'progress-bar' + (member.progress.percentage === 100 ? ' complete' : '');
      progressBar.style.width = member.progress.percentage + '%';

      progressBarContainer.appendChild(progressBar);
      progress.appendChild(progressHeader);
      progress.appendChild(progressBarContainer);
      card.appendChild(progress);

      // Missed tasks badge
      if (member.missedTasks.length > 0 && !member.routineComplete) {
        var missedBadge = document.createElement('div');
        missedBadge.className = 'missed-tasks-badge';

        var hourglassIcon = document.createElement('span');
        hourglassIcon.textContent = '\u{23F3} ';
        missedBadge.appendChild(hourglassIcon);

        var missedText = document.createTextNode(member.missedTasks.length + ' task' + (member.missedTasks.length !== 1 ? 's' : '') + ' remaining');
        missedBadge.appendChild(missedText);

        card.appendChild(missedBadge);
      }

      // Quick actions (only for children)
      if (member.role === 'child' && !member.routineComplete) {
        var actions = document.createElement('div');
        actions.className = 'quick-actions';

        var sickDayBtn = document.createElement('button');
        sickDayBtn.className = 'action-btn sick-day';

        var sickIcon = document.createElement('span');
        sickIcon.textContent = '\u{1F912} ';
        sickDayBtn.appendChild(sickIcon);

        var sickText = document.createTextNode('Mark Sick Day');
        sickDayBtn.appendChild(sickText);

        sickDayBtn.onclick = function(e) {
          e.stopPropagation();
          markSickDay(member.id, member.name);
        };

        actions.appendChild(sickDayBtn);
        card.appendChild(actions);
      }

      return card;
    }

    // Mark sick day for a member
    async function markSickDay(userId, userName) {
      if (!confirm('Mark today as a sick day for ' + userName + '? Their remaining tasks will be marked complete without earning money.')) {
        return;
      }

      try {
        var token = localStorage.getItem('token');
        var response = await fetch('./api/family/sick-day/' + userId, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to mark sick day');
        }

        var data = await response.json();
        alert(data.message);

        // Reload dashboard to reflect changes
        loadDashboard();
      } catch (err) {
        console.error('Error marking sick day:', err);
        alert('Failed to mark sick day');
      }
    }

    // Open member detail modal
    async function openMemberModal(member) {
      var modal = document.getElementById('member-modal');
      var modalLoading = document.getElementById('modal-loading');
      var modalContent = document.getElementById('modal-content');

      // Set basic info
      var avatar = document.getElementById('modal-avatar');
      if (member.avatar) {
        avatar.style.backgroundColor = member.avatar.color || '#E0E0E0';
        avatar.textContent = member.avatar.emoji || '\u{1F464}';
      } else {
        avatar.style.backgroundColor = '#E0E0E0';
        avatar.textContent = '\u{1F464}';
      }

      document.getElementById('modal-name').textContent = member.name;
      document.getElementById('modal-role').textContent = member.role;

      // Show modal with loading state
      modalLoading.style.display = 'flex';
      modalContent.style.display = 'none';
      modal.classList.add('visible');

      try {
        var token = localStorage.getItem('token');
        var response = await fetch('./api/family/member/' + member.id, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load member details');
        }

        var data = await response.json();
        renderModalContent(data);

        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
      } catch (err) {
        console.error('Error loading member details:', err);
        closeModal();
        alert('Failed to load member details');
      }
    }

    // Render modal content
    function renderModalContent(data) {
      // Stats
      document.getElementById('modal-streak').textContent = data.streak.current + ' day streak (best: ' + data.streak.best + ')';
      document.getElementById('modal-balance').textContent = data.balance.formatted;

      // Tasks
      var tasksContainer = document.getElementById('modal-tasks');
      // Clear container safely
      while (tasksContainer.firstChild) {
        tasksContainer.removeChild(tasksContainer.firstChild);
      }

      var allTasks = [];
      data.routines.forEach(function(routine) {
        routine.tasks.forEach(function(task) {
          allTasks.push(task);
        });
      });

      if (allTasks.length === 0) {
        var emptyMsg = document.createElement('div');
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.color = '#757575';
        emptyMsg.style.padding = '20px';
        emptyMsg.textContent = 'No tasks scheduled for today';
        tasksContainer.appendChild(emptyMsg);
      } else {
        allTasks.forEach(function(task) {
          var taskItem = document.createElement('div');
          taskItem.className = 'task-item' + (task.isCompleted ? ' completed' : ' missed');

          var icon = document.createElement('span');
          icon.className = 'task-icon';
          icon.textContent = task.icon || '\u{2705}';

          var taskName = document.createElement('span');
          taskName.className = 'task-name';
          taskName.textContent = task.name;

          var status = document.createElement('span');
          status.className = 'task-status';
          status.textContent = task.isCompleted ? '\u{2705}' : '\u{23F3}';

          taskItem.appendChild(icon);
          taskItem.appendChild(taskName);
          taskItem.appendChild(status);
          tasksContainer.appendChild(taskItem);
        });
      }

      // Transactions
      var transactionsContainer = document.getElementById('modal-transactions');
      // Clear container safely
      while (transactionsContainer.firstChild) {
        transactionsContainer.removeChild(transactionsContainer.firstChild);
      }

      if (data.recentTransactions.length === 0) {
        var emptyTxMsg = document.createElement('div');
        emptyTxMsg.style.textAlign = 'center';
        emptyTxMsg.style.color = '#757575';
        emptyTxMsg.style.padding = '20px';
        emptyTxMsg.textContent = 'No recent earnings';
        transactionsContainer.appendChild(emptyTxMsg);
      } else {
        data.recentTransactions.forEach(function(tx) {
          var txItem = document.createElement('div');
          txItem.className = 'transaction-item';

          var desc = document.createElement('span');
          desc.className = 'transaction-desc';
          desc.textContent = tx.description;

          var amount = document.createElement('span');
          amount.className = 'transaction-amount ' + (tx.amount >= 0 ? 'positive' : 'negative');
          amount.textContent = (tx.amount >= 0 ? '+' : '') + '$' + Math.abs(tx.amount).toFixed(2);

          txItem.appendChild(desc);
          txItem.appendChild(amount);
          transactionsContainer.appendChild(txItem);
        });
      }
    }

    // Close modal
    function closeModal() {
      var modal = document.getElementById('member-modal');
      modal.classList.remove('visible');
    }

    // Close modal when clicking outside
    document.getElementById('member-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Close modal with escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Logout
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      ingressRedirect('/login.html');
    }
  </script>
</body>
</html>
